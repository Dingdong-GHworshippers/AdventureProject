import {getEmployees, deleteEmployee, createEmployee} from "./api/employeeApi.js";
import { getTimeslots, assignEmployee } from "./api/activityTimeslotApi.js";
import { sortBy } from "./util/sortUtil.js";

console.log("✅ app.js loaded");
window.addEventListener("DOMContentLoaded", initApp);

// === Sort globals ===
let currentSortKey = "id";
let isAscending = true;

function initApp(){
    reloadAndRender();
    setupEventListeners()
}

function setupEventListeners() {
    const tableBody = document.querySelector("#employee-table-body");
    tableBody.addEventListener("click", handleTableClick);
    const form = document.querySelector("#employee-form");
    form.addEventListener("submit", handleFormSubmit);
    document.querySelector("#employee-table thead").addEventListener("click", handleSortClick);

}

async function reloadAndRender() {
    try {
        const employees = await getEmployees();
        console.log("Fetched activities:", employees);
        const sortedEmployees = employees.sort(sortBy(currentSortKey, isAscending))
        renderTable(sortedEmployees);
        updateSortIndicator();
        await renderRoster();
    } catch (e) {
        console.error("Failed to fetch employees:", e);
    }
}

function updateSortIndicator() {
    const thElems = document.querySelectorAll("th[data-key]");
    thElems.forEach(th => {
        th.classList.remove("sorted-asc", "sorted-desc");
        if (th.getAttribute("data-key") === currentSortKey) {
            th.classList.add(isAscending ? "sorted-asc" : "sorted-desc");
        }
    });
}



//--- EVENT ----//
async function handleFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    const employee = {
        userName: formData.get("username"),
        password: formData.get("password"),
        role: formData.get("role"),
    };

    await createEmployee(employee);
    form.reset();
    await reloadAndRender();
}


async function handleTableClick(event) {
    const target = event.target;
    if (target.classList.contains("delete-button")) {
        const row = target.closest("tr");
        const employeeId = row.getAttribute("data-id");
        try {
            await deleteEmployee(employeeId);
        } catch (e) {
            const message = e.message || "Failed to delete employee.";
            alert(message);
        }
        await reloadAndRender();
    }
}
async function handleSortClick(event) {
    const th = event.target.closest("th");
    if (th === null || th === undefined) {

        return;
    }

    const key = th.getAttribute("data-key");

    if (!key) {
        return;
    }

    if (key === currentSortKey) {
        isAscending = !isAscending;
    } else {
        currentSortKey = key;
        isAscending = true;
    }
    await reloadAndRender();
}


function renderTable(employee){
    const tableBody = document.querySelector("#employee-table-body");
    tableBody.innerHTML = "";
    employee.forEach(renderRow);

}

function renderRow(employee){
    const tableBody = document.querySelector("#employee-table-body")
    const html = /*html*/ `
        <tr data-id="${employee.id}">
            <td>${employee.id}</td>
            <td>${employee.userName}</td>
            <td>${employee.role}</td>
            <td>
                <button class="delete-button">Delete</button>
            </td>
        </tr>
    `;
    tableBody.insertAdjacentHTML("beforeend", html);
}

// ----- ROSTER ---
async function renderRoster() {
    const rosterBody = document.querySelector("#roster-table-body");
    rosterBody.innerHTML = "";

    // 1️⃣ Fetch all timeslots from backend
    const timeslots = await getTimeslots();

    // 2️⃣ Filter out the autogenerated empty ones
    const validTimeslots = timeslots.filter(ts => ts.activity !== null);

    // 3️⃣ Render only valid timeslots
    validTimeslots.forEach(ts => {
        const activityName = ts.activity?.activityName || "—";
        const dateObj = new Date(ts.startTime);
        const date = dateObj.toLocaleDateString("da-DK"); // or "en-GB", "en-US"
        const start = ts.startTime ? ts.startTime.substring(11, 16) : "—";
        const end = ts.endTime ? ts.endTime.substring(11, 16) : "—";
        const employees = (ts.employees && ts.employees.length > 0)
            ? ts.employees.map(e => e.userName).join(", ")
            : "—";

        const html = `
      <tr data-id="${ts.id}">
        <td>${activityName}</td>
        <td>${date}</td>
        <td>${start}</td>
        <td>${end}</td>
        <td>${employees}</td>
        <td>
          <button class="assign-button">Assign</button>
        </td>
      </tr>`;
        rosterBody.insertAdjacentHTML("beforeend", html);
    });
}


document.querySelector("#roster-table-body").addEventListener("click", async (event) => {
    const target = event.target;
    if (target.classList.contains("assign-button")) {
        const timeslotId = target.closest("tr").getAttribute("data-id");
        const employeeId = prompt("Enter employee ID to assign:");
        if (employeeId) {
            await assignEmployee(timeslotId, employeeId);
            await renderRoster();
        }
    }
});


